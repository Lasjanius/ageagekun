<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±…å®…ç™‚é¤Šç®¡ç†æŒ‡å°å ±å‘Šæ›¸</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ˜</text></svg>">
    <style>
        @page {
            size: A4;
            margin: 9mm 12mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Yu Gothic', 'YuGothic', 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            color: #333;
            background: white;
        }

        .container {
            width: 210mm;
            min-height: 250mm;
            max-height: 277mm;
            margin: 0 auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */
        .header {
            text-align: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid #333;
        }

        .title {
            font-size: 20pt;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .period {
            font-size: 12pt;
            color: #666;
        }

        /* é€ã‚Šå…ƒãƒ»é€ã‚Šå…ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .correspondence-section {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .sender-info, .recipient-info {
            width: 48%;
        }

        .sender-info {
            border-right: 1px solid #dee2e6;
            padding-right: 15px;
        }

        .recipient-info {
            padding-left: 15px;
        }

        .section-label {
            font-size: 11pt;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .clinic-name {
            font-weight: bold;
            font-size: 13pt;
            margin-bottom: 5px;
        }

        .clinic-address {
            font-size: 11pt;
            color: #495057;
            line-height: 1.4;
        }

        .recipient-name {
            font-size: 13pt;
            font-weight: bold;
        }

        .office-name {
            font-size: 12pt;
            font-weight: bold;
            margin-top: 8px;
            color: #333;
        }

        .office-address {
            font-size: 11pt;
            color: #495057;
            margin-top: 5px;
            line-height: 1.4;
        }

        /* æ‚£è€…æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .patient-section {
            margin: 8px 0;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: #fafafa;
        }

        .patient-name-row {
            display: flex;
            align-items: baseline;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #e8f4fd;
            border-left: 4px solid #007bff;
            border-radius: 3px;
        }

        .patient-name {
            font-size: 16pt;
            font-weight: bold;
            color: #1a1a1a;
        }

        .patient-name-suffix {
            font-size: 14pt;
            font-weight: normal;
            margin-left: 8px;
            color: #333;
        }

        .patient-info-grid {
            display: grid;
            gap: 12px;
        }

        .info-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 15px;
            align-items: baseline;
        }

        .info-label {
            font-weight: bold;
            color: #495057;
            font-size: 12pt;
            text-align: right;
        }

        .info-value {
            font-size: 12pt;
            color: #333;
            padding-left: 10px;
        }

        /* è¨ºå¯Ÿæƒ…å ±ã‚°ãƒªãƒƒãƒ‰ */
        .medical-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 8px 0;
        }

        .info-item {
            display: flex;
            align-items: baseline;
            font-size: 12pt;
        }

        .info-label {
            font-weight: bold;
            color: #495057;
            margin-right: 10px;
            min-width: 90px;
        }

        .info-value {
            flex: 1;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        /* ä¸»è¦æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .main-info-section {
            margin: 8px 0;
        }

        .main-info-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }

        .main-info-cell {
            display: flex;
            align-items: baseline;
        }

        .main-info-label {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
            font-size: 12pt;
        }

        .main-info-cell > span:last-child {
            font-size: 12pt;
            flex: 1;
        }

        /* æŒ‡å°å†…å®¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - å¯å¤‰é«˜ã• */
        .guidance-section {
            flex-grow: 1;
            margin: 10px 0;
            padding: 12px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }

        .guidance-title {
            font-size: 16pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #007bff;
        }

        .subsection {
            margin: 8px 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .subsection-title {
            font-size: 14pt;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 3px solid #28a745;
        }

        .content-area {
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 3px;
            min-height: 115px;
            height: 115px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
            font-size: 12pt;
        }

        /* ç”Ÿæ´»æŒ‡å°ãƒªã‚¹ãƒˆ */
        .advice-list {
            margin: 10px 0;
            padding-left: 0;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .advice-item {
            margin: 3px 0;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            display: flex;
            align-items: flex-start;
            font-size: 12pt;
        }

        .advice-checkbox {
            margin-right: 10px;
            margin-top: 3px;
            accent-color: #28a745;
            width: 18px;
            height: 18px;
            cursor: default;
        }

        .advice-checkbox:checked {
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
        }

        .advice-item[style*="display: flex"] {
            background: #f0fff4;
            border-color: #28a745;
        }

        .advice-type {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
            white-space: nowrap;
        }

        .advice-content {
            flex: 1;
            color: #495057;
            line-height: 1.5;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ - æœ€ä¸‹éƒ¨å›ºå®š */
        .footer {
            margin-top: auto;
            padding: 8px 0 5px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            font-size: 10pt;
            color: #6c757d;
        }

        /* A4 å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            @page {
                size: A4;
                margin: 8mm 10mm;
            }

            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                line-height: 1.4;
            }

            .container {
                padding: 0;
                width: 100%;
                height: auto;
                max-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .correspondence-section,
            .patient-section,
            .guidance-section {
                box-shadow: none;
                page-break-inside: avoid;
            }

            .content-area {
                max-height: none;
                overflow-y: visible;
            }

            .footer {
                margin-top: auto;
                width: 100%;
            }

            /* æ”¹ãƒšãƒ¼ã‚¸é˜²æ­¢ */
            .header,
            .correspondence-section,
            .patient-section,
            .medical-info-grid,
            .main-info-section,
            .guidance-section {
                page-break-inside: avoid;
            }

            /* ä¸è¦ãªè¦ç´ ã‚’éè¡¨ç¤º */
            .no-print {
                display: none !important;
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media screen and (max-width: 768px) {
            .correspondence-section {
                flex-direction: column;
            }

            .sender-info, .recipient-info {
                width: 100%;
                border: none;
                padding: 10px 0;
            }

            .medical-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ç·¨é›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .edit-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .edit-btn, .reset-btn, .save-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .edit-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .reset-btn {
            background: #ff6b6b;
            color: white;
        }

        .reset-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .save-btn {
            background: #4CAF50;
            color: white;
        }

        .save-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .save-status {
            padding: 8px 12px;
            background: #e8f5e9;
            border-radius: 6px;
            color: #2e7d32;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .save-status.saving {
            background: #fff3e0;
            color: #f57c00;
        }

        .save-status.error {
            background: #ffebee;
            color: #c62828;
        }

        /* ç·¨é›†å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .editable-field {
            transition: all 0.3s ease;
            position: relative;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .editable-field[contenteditable="true"] {
            background: #fffbf0;
            outline: 1px dashed #ffa500;
            cursor: text;
            min-height: 1.2em;
        }

        .editable-field[contenteditable="true"]:hover {
            background: #fff8e1;
            outline: 2px dashed #ff9800;
        }

        .editable-field[contenteditable="true"]:focus {
            background: #ffffff;
            outline: 2px solid #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }

        /* é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ç·¨é›†ã‚¹ã‚¿ã‚¤ãƒ« */
        .content-area[contenteditable="true"] {
            min-height: 100px;
            padding: 8px;
            background: #fffbf0;
            outline: 1px dashed #ffa500;
            cursor: text;
        }

        .content-area[contenteditable="true"]:focus {
            background: #ffffff;
            outline: 2px solid #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }

        /* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ */
        .validation-error {
            outline: 2px solid #f44336 !important;
            background: #ffebee !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* ç·¨é›†ä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .editing-indicator {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 11px;
            color: #4CAF50;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .editable-field[contenteditable="true"]:focus + .editing-indicator {
            display: block;
        }

        /* ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .advice-selector-container {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .advice-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .advice-selector-header h4 {
            margin: 0;
            font-size: 16px;
            color: #495057;
            font-weight: 600;
        }

        .advice-counter {
            padding: 6px 12px;
            background: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .advice-counter.max-reached {
            background: #ffebee;
            color: #dc3545;
        }

        .counter-current {
            color: #007bff;
            font-weight: 600;
        }

        .counter-max {
            color: #6c757d;
        }

        /* é¸æŠæ¸ˆã¿ã‚¿ã‚°ã‚¨ãƒªã‚¢ */
        .selected-advice-tags {
            min-height: 44px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .selected-advice-tags:empty::before {
            content: "é¸æŠã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™";
            color: #adb5bd;
            font-size: 14px;
            font-style: italic;
            padding: 10px;
        }

        .advice-tag {
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tag-text {
            margin-right: 8px;
        }

        .tag-remove {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            padding: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tag-remove:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .advice-dropdown-wrapper {
            position: relative;
        }

        .advice-search {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .advice-search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .advice-search:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆ */
        .advice-dropdown-list {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            max-height: 320px;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .advice-dropdown-list::-webkit-scrollbar {
            width: 8px;
        }

        .advice-dropdown-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }

        .advice-dropdown-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 8px;
        }

        .advice-dropdown-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .advice-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f3f5;
        }

        .advice-option:last-child {
            border-bottom: none;
        }

        .advice-option:hover {
            background: #f8f9fa;
        }

        .advice-option:focus {
            background: #e7f5ff;
            outline: none;
        }

        .advice-option.selected {
            background: #e8f5e9;
            color: #2e7d32;
            pointer-events: none;
        }

        .advice-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #fafafa;
        }

        .advice-option-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }

        .advice-option-content {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }

        /* ç©ºã®çŠ¶æ…‹ */
        .advice-dropdown-empty {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media screen and (max-width: 768px) {
            .advice-selector-container {
                padding: 15px;
            }

            .advice-selector-header {
                flex-direction: column;
                gap: 10px;
            }

            .advice-tag {
                font-size: 13px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- ç·¨é›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="edit-controls no-print">
        <button id="toggleEditMode" class="edit-btn">
            <span class="edit-icon">âœï¸</span>
            <span class="edit-text">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
        </button>
        <button id="saveChanges" class="save-btn">
            <span class="save-icon">ğŸ’¾</span>
            <span class="save-text">ã“ã®å†…å®¹ã§ä¿å­˜</span>
        </button>
        <span id="saveStatus" class="save-status" style="display: none;">
            <span class="status-icon"></span>
            <span class="status-text"></span>
        </span>
    </div>

    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <h1 class="title">å±…å®…ç™‚é¤Šç®¡ç†æŒ‡å°å ±å‘Šæ›¸</h1>
            <div class="period" data-field="period">å¯¾è±¡æœŸé–“ï¼š{{period_start}} ï½ {{period_end}}</div>
        </header>

        <!-- é€ã‚Šå…ƒãƒ»é€ã‚Šå…ˆæƒ…å ± -->
        <section class="correspondence-section">
            <div class="sender-info">
                <div class="section-label"></div>
                <div class="clinic-name">ãŸã™ããƒ›ãƒ¼ãƒ ã‚¯ãƒªãƒ‹ãƒƒã‚¯</div>
                <div class="clinic-address">
                    ã€’242-0003<br>
                    ç¥å¥ˆå·çœŒå¤§å’Œå¸‚æ—é–“1-5-7-201<br>
                    TEL 046-206-7131 / FAX 046-206-7132
                </div>
            </div>
            <div class="recipient-info">
                <div class="section-label"></div>
                <div class="recipient-name">ã”æ‹…å½“ã€€<span data-field="cm_name">{{cm_name}}</span>ã€€æ§˜</div>
                <div class="office-name" data-field="homecare_office_name">{{homecare_office_name}}</div>
                <div class="office-address" data-field="homecare_office_address">{{homecare_office_address}}</div>
            </div>
        </section>

        <!-- æ‚£è€…æƒ…å ± -->
        <section class="patient-section">
            <!-- æ‚£è€…IDï¼ˆéè¡¨ç¤ºï¼‰ -->
            <span data-field="patient_id" style="display: none;">{{patient_id}}</span>
            <div class="patient-name-row">
                <span class="patient-name" data-field="patient_name">{{patient_name}}</span>
                <span class="patient-name-suffix">æ§˜</span>
            </div>

            <div class="patient-info-grid">
                <div class="info-row">
                    <span class="info-label">ç”Ÿå¹´æœˆæ—¥ï¼š</span>
                    <span class="info-value" data-field="birthdate">{{birthdate}}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¹´é½¢ï¼š</span>
                    <span class="info-value"><span data-field="age">{{age}}</span>æ­³</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ã”ä½æ‰€ï¼š</span>
                    <span class="info-value" data-field="address">{{address}}</span>
                </div>
            </div>
        </section>

        <!-- è¨ºå¯Ÿæƒ…å ± -->
        <section class="medical-info-grid">
            <div class="info-item">
                <span class="info-label">è¨ºå¯Ÿæ—¥ï¼š</span>
                <span class="info-value" data-field="exam_date">{{exam_date}}</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ¬¡å›è¨ºå¯Ÿæ—¥ï¼š</span>
                <span class="info-value" data-field="next_exam_date">{{next_exam_date}}</span>
            </div>
        </section>

        <!-- ä¸»è¦æƒ…å ± -->
        <section class="main-info-section">
            <div class="main-info-grid">
                <div class="main-info-cell">
                    <span class="main-info-label">ä»‹è­·åº¦ï¼š</span>
                    <span data-field="care_level">{{care_level}}</span>
                </div>
                <div class="main-info-cell">
                    <span class="main-info-label">ä¸»ç—…åï¼š</span>
                    <span data-field="primary_disease">{{primary_disease}}</span>
                </div>
            </div>
        </section>

        <!-- å±…å®…ç™‚é¤Šç®¡ç†æŒ‡å°å†…å®¹ãƒ»æ²»ç™‚çµŒé -->
        <section class="guidance-section">
            <h2 class="guidance-title">å±…å®…ç™‚é¤Šç®¡ç†æŒ‡å°å†…å®¹ãƒ»æ²»ç™‚çµŒé</h2>

            <div class="subsection">
                <h3 class="subsection-title">è¨ºç™‚å†…å®¹</h3>
                <div class="content-area" data-field="medical_content">{{medical_content}}</div>
            </div>

            <div class="subsection">
                <h3 class="subsection-title">å±…å®…ç™‚é¤Šã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ»æ—¥å¸¸ç”Ÿæ´»ã®æ³¨æ„ç‚¹</h3>

                <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div class="advice-selector-container no-print" style="display: none;">
                    <div class="advice-selector-header">
                        <h4>ã‚¢ãƒ‰ãƒã‚¤ã‚¹é …ç›®ã‚’é¸æŠï¼ˆæœ€å¤§3ã¤ã¾ã§ï¼‰</h4>
                        <span class="advice-counter">
                            <span class="counter-current">0</span> / <span class="counter-max">3</span>
                        </span>
                    </div>

                    <!-- é¸æŠæ¸ˆã¿ã‚¿ã‚°ã‚¨ãƒªã‚¢ -->
                    <div class="selected-advice-tags"></div>

                    <!-- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ -->
                    <div class="advice-dropdown-wrapper">
                        <input type="text"
                               class="advice-search"
                               placeholder="ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ã¾ãŸã¯é¸æŠ..."
                               aria-label="ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ¤œç´¢"
                               aria-expanded="false"
                               aria-controls="advice-dropdown-list"
                               autocomplete="off">
                        <div class="advice-dropdown-list"
                             id="advice-dropdown-list"
                             role="listbox"
                             style="display: none;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <div class="advice-list">
                    <div class="advice-item" data-advice="hypertension" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">é«˜è¡€åœ§ç”Ÿæ´»æŒ‡å°ï¼š</span>
                        <span class="advice-content">æ¸›å¡©é£Ÿã‚„é©åº¦ãªé‹å‹•ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="diabetes" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">ç³–å°¿ç—…ç”Ÿæ´»æŒ‡å°ï¼š</span>
                        <span class="advice-content">é–“é£Ÿã‚’æ§ãˆã‚‹ã‚ˆã†ã«ã€‚æœè–¬ä¸­ã®æ–¹ã¯ä½è¡€ç³–ç—‡çŠ¶ã«ã‚‚è¦æ³¨æ„ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="kidney" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">è…è‡“ç—…ç”Ÿæ´»æŒ‡å°ï¼š</span>
                        <span class="advice-content">è¡€åœ§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€ãŸã‚“ã±ãè³ªåˆ¶é™ã€ã‚«ãƒªã‚¦ãƒ ã®å¤šã„é£Ÿã¹ç‰©ã‚’æ§ãˆã‚‹ã‚ˆã†ã«ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="lipid" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">è„‚è³ªä»£è¬ç•°å¸¸ç—‡ï¼š</span>
                        <span class="advice-content">é£Ÿäº‹ãƒãƒ©ãƒ³ã‚¹ã‚’è‰¯ãã—ã€é‹å‹•ã‚’ã™ã‚‹ã‚ˆã†ã«ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="dementia" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">ç‰©å¿˜ã‚ŒæŒ‡å°ï¼š</span>
                        <span class="advice-content">æœè–¬ã®è¦‹å®ˆã‚Šãªã©ç´°ã‹ã„ä»‹è­·ã«ã¦å¯¾å¿œã€‚æ°—åˆ†ã®å¤‰åŒ–ãªã©ã«ç•™æ„ã—ã¾ã—ã‚‡ã†ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="fall_prevention" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">è»¢å€’äºˆé˜²æŒ‡å°ï¼š</span>
                        <span class="advice-content">æ—¥å¸¸ç”Ÿæ´»ã®ä¸­ã§æ­©è¡Œè¨“ç·´ã‚’ã—ã€è»¢å€’ã«ååˆ†æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="bedridden" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">å¯ãŸãã‚ŠæŒ‡å°ï¼š</span>
                        <span class="advice-content">æ‹˜ç¸®äºˆé˜²ã€è¤¥ç˜¡é˜²æ­¢ã€é•·æ™‚é–“åŒã˜å§¿å‹¢ã‚’å–ã‚‰ãªã„ã‚ˆã†ã«ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="malnutrition" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">ä½æ „é¤ŠæŒ‡å°ï¼š</span>
                        <span class="advice-content">ä½æ „é¤Šã«å¯¾ã—ã¦ã€æ „é¤Šå‰¤ã®è£œé£Ÿã‚’æŒ‡å°ã€‚</span>
                    </div>
                    <div class="advice-item" data-advice="aspiration" style="display: none;">
                        <input type="checkbox" class="advice-checkbox" checked readonly>
                        <span class="advice-type">èª¤åš¥é˜²æ­¢æŒ‡å°ï¼š</span>
                        <span class="advice-content">åš¥ä¸‹èƒ½åŠ›ã«ã‚ã£ãŸé£Ÿäº‹å½¢çŠ¶ã‚’å·¥å¤«ã—ã€é£Ÿäº‹ã¯ã‚†ã£ãã‚Šæ‘‚ã‚Šã¾ã—ã‚‡ã†ã€‚</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="footer">
            <div class="generated-info">
            </div>
        </footer>
    </div>

    <!-- ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆJavaScript -->
    <script src="../js/report_generator.js"></script>

    <script>
        // ========================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ========================================

        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°ï¼ˆé€£ç¶šå®Ÿè¡Œã‚’åˆ¶é™ï¼‰
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå‡¦ç†ï¼ˆv2.1.1 - 3å±¤ã‹ã‚‰1å±¤ã¸ï¼‰
        function migrateDataIfNeeded() {
            // æ—¢ã«ç§»è¡Œæ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            if (localStorage.getItem('migration_v2_1_1_completed')) {
                console.log('[Migration] æ—¢ã«ç§»è¡Œæ¸ˆã¿ã§ã™');
                return;
            }

            try {
                const original = JSON.parse(localStorage.getItem('originalReportData') || '{}');
                const edited = JSON.parse(localStorage.getItem('editedReportData') || '{}');
                const current = JSON.parse(localStorage.getItem('kyotakuReportData') || '{}');

                // æ—¢å­˜ã®kyotakuReportDataã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒãƒ¼ã‚¸
                const finalData = Object.keys(current).length > 0 ? current : {...original, ...edited};

                if (Object.keys(finalData).length > 0) {
                    localStorage.setItem('kyotakuReportData', JSON.stringify(finalData));
                    console.log('[Migration] ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Œäº†:', finalData);
                }

                localStorage.setItem('migration_v2_1_1_completed', Date.now().toString());

                // å¤ã„ã‚­ãƒ¼ã¯å‰Šé™¤ã—ãªã„ï¼ˆå¿µã®ãŸã‚æ®‹ã™ï¼‰
                console.log('[Migration] v2.1.1ã¸ã®ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('[Migration] ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚¢ãƒ—ãƒªã¯ç¶™ç¶š
            }
        }

        // ç§»è¡Œå‡¦ç†ã‚’å®Ÿè¡Œ
        migrateDataIfNeeded();

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®JavaScript
        window.KyotakuReportTemplate = {
            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«é©ç”¨ã™ã‚‹é–¢æ•°
            applyData: function(data) {
                console.log('[KyotakuReportTemplate.applyData] å ±å‘Šæ›¸ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ä¸­:', data);
                console.log('[KyotakuReportTemplate.applyData] å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');
                console.log('[KyotakuReportTemplate.applyData] officeAddresså€¤:', data.officeAddress);
                console.log('[KyotakuReportTemplate.applyData] primaryDiseaseå€¤:', data.primaryDisease);
                console.log('[KyotakuReportTemplate.applyData] nextExamDateå€¤:', data.nextExamDate);

                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ç½®æ›ï¼ˆç‰¹æ®Šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                document.querySelectorAll('[data-field]').forEach(element => {
                    const field = element.getAttribute('data-field');
                    // periodãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¾Œã§ç‰¹åˆ¥å‡¦ç†ã™ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
                    if (field === 'period') {
                        return;
                    }

                    let value = data[field];
                    // birthdateã®æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ï¼ˆYYYY-MM-DD â†’ YYYYå¹´MMæœˆDDæ—¥ï¼‰
                    if (field === 'birthdate' && value) {
                        const dateMatch = value.match(/(\d{4})-(\d{2})-(\d{2})/);
                        if (dateMatch) {
                            value = `${dateMatch[1]}å¹´${parseInt(dateMatch[2])}æœˆ${parseInt(dateMatch[3])}æ—¥`;
                        }
                    }

                    if (value !== undefined && value !== null) {
                        if (element.textContent) {
                            // è¤‡æ•°ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€æœ€åˆã®ã‚‚ã®ã ã‘ã‚’ç½®æ›
                            element.textContent = element.textContent.replace(/\{\{[^}]*?\}\}/, value);
                        }
                    }
                });

                // è¨ºç™‚å†…å®¹ã®æ”¹è¡Œå‡¦ç†ã¨è¡¨ç¤º
                if (data.medicalContent) {
                    const medicalContentElement = document.querySelector('[data-field="medical_content"]');
                    if (medicalContentElement) {
                        // æ”¹è¡Œæ–‡å­—ã‚’<br>ã«å¤‰æ›ã—ã¦è¡¨ç¤º
                        medicalContentElement.innerHTML = data.medicalContent.replace(/\n/g, '<br>');
                    }
                }

                // ç”Ÿæ´»æŒ‡å°æ–‡ã®è¡¨ç¤º
                if (data.adviceText) {
                    const adviceTextElement = document.querySelector('[data-field="advice_text"]');
                    if (adviceTextElement) {
                        adviceTextElement.textContent = data.adviceText;
                    }
                }

                // ç”Ÿæ´»æŒ‡å°é …ç›®ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆè©²å½“ã™ã‚‹é …ç›®ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºï¼‰
                if (data.advices && Array.isArray(data.advices) && data.advices.length > 0) {
                    data.advices.forEach(adviceType => {
                        const adviceElement = document.querySelector(`[data-advice="${adviceType}"]`);
                        if (adviceElement) {
                            adviceElement.style.display = 'flex';
                        }
                    });
                } else {
                    // advicesãŒç©ºã¾ãŸã¯æœªå®šç¾©ã®å ´åˆã€ä¸»ç—…åã‹ã‚‰æ¨æ¸¬ã™ã‚‹ã‹ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
                    console.log('[KyotakuReportTemplate.applyData] advicesé…åˆ—ãŒç©ºã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™');

                    // ä¸»ç—…åã«åŸºã¥ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ±ºå®š
                    const primaryDisease = data.primaryDisease || '';
                    let defaultAdvices = [];

                    if (primaryDisease.includes('èªçŸ¥ç—‡') || primaryDisease.includes('ã‚¢ãƒ«ãƒ„ãƒã‚¤ãƒãƒ¼')) {
                        defaultAdvices.push('dementia');
                    }
                    if (primaryDisease.includes('é«˜è¡€åœ§')) {
                        defaultAdvices.push('hypertension');
                    }
                    if (primaryDisease.includes('ç³–å°¿ç—…')) {
                        defaultAdvices.push('diabetes');
                    }

                    // ä½•ã‚‚è©²å½“ã—ãªã„å ´åˆã¯è»¢å€’äºˆé˜²ã‚’è¡¨ç¤º
                    if (defaultAdvices.length === 0) {
                        defaultAdvices.push('fall_prevention');
                    }

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
                    defaultAdvices.forEach(adviceType => {
                        const adviceElement = document.querySelector(`[data-advice="${adviceType}"]`);
                        if (adviceElement) {
                            adviceElement.style.display = 'flex';
                        }
                    });
                }

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆAIå ±å‘Šæ›¸ã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã¨è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¯¾å¿œï¼‰
                const fieldMapping = {
                    'patientId': 'patient_id',
                    'patientName': 'patient_name',
                    'cmName': 'cm_name',
                    'officeName': 'homecare_office_name',
                    'officeAddress': 'homecare_office_address',
                    'periodStart': 'period',
                    'periodEnd': 'period',
                    'careLevel': 'care_level',
                    'primaryDisease': 'primary_disease',
                    'examDate': 'exam_date',
                    'nextExamDate': 'next_exam_date',
                    'doctorName': 'doctor_name'
                };

                // ãƒãƒƒãƒ”ãƒ³ã‚°ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                Object.keys(fieldMapping).forEach(sourceKey => {
                    // undefinedã§ãªã„é™ã‚Šå‡¦ç†ï¼ˆç©ºæ–‡å­—åˆ—ã‚‚å«ã‚€ï¼‰
                    if (data[sourceKey] !== undefined) {
                        const targetField = fieldMapping[sourceKey];
                        const elements = document.querySelectorAll(`[data-field="${targetField}"]`);
                        elements.forEach(element => {
                            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
                            console.log(`Setting ${targetField}: "${data[sourceKey]}"`);
                            if (element.textContent.includes('{{')) {
                                element.textContent = element.textContent.replace(/\{\{.*?\}\}/g, data[sourceKey] || '');
                            } else {
                                element.textContent = data[sourceKey] || '';
                            }
                        });
                    }
                });

                // æœŸé–“æƒ…å ±ã®ç‰¹åˆ¥å‡¦ç†
                if (data.periodStart && data.periodEnd) {
                    console.log('[KyotakuReportTemplate.applyData] æœŸé–“ã‚’è¨­å®š:', data.periodStart, 'ï½', data.periodEnd);
                    const periodElement = document.querySelector('[data-field="period"]');
                    if (periodElement) {
                        periodElement.textContent = `å¯¾è±¡æœŸé–“: ${data.periodStart} ï½ ${data.periodEnd}`;
                    }
                }
            },

            // LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            loadFromLocalStorage: function() {
                try {
                    const storedData = localStorage.getItem('kyotakuReportData');
                    if (storedData) {
                        const data = JSON.parse(storedData);
                        console.log('LocalStorageã‹ã‚‰å ±å‘Šæ›¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', data);
                        return data;
                    }
                } catch (error) {
                    console.error('LocalStorageã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
                return null;
            },

            // LocalStorageã‚’ã‚¯ãƒªã‚¢
            clearLocalStorage: function() {
                localStorage.removeItem('kyotakuReportData');
                console.log('LocalStorageã®å ±å‘Šæ›¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            },

            // å°åˆ·ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
            preparePrint: function() {
                window.print();
            },

            // PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã®æº–å‚™ï¼ˆè¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
            exportPDF: async function(filename = 'å±…å®…ç™‚é¤Šç®¡ç†æŒ‡å°æ›¸.pdf') {
                // html2pdfã‚„jsPDFãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
                console.log('PDF export functionality requires additional library');
            },

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            getSampleData: function() {
                console.error('[KyotakuReportTemplate.getSampleData] âŒ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
                console.error('[KyotakuReportTemplate.getSampleData] âŒ ã“ã‚Œã¯æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã•ã‚Œã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼');
                return {
                    period_start: '2024å¹´1æœˆ1æ—¥',
                    period_end: '2024å¹´1æœˆ31æ—¥',
                    cm_name: 'å±±ç”°å¤ªéƒ',
                    homecare_office_name: 'ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã‚»ãƒ³ã‚¿ãƒ¼ã‚„ã¾ã¨',
                    homecare_office_address: 'ã€’242-0001 ç¥å¥ˆå·çœŒå¤§å’Œå¸‚ä¸­å¤®1-2-3',
                    patient_name: 'ä½è—¤èŠ±å­',
                    birthdate: '1940å¹´5æœˆ15æ—¥',
                    age: '83',
                    address: 'ç¥å¥ˆå·çœŒå¤§å’Œå¸‚æ—é–“2-3-4',
                    exam_date: '2024å¹´1æœˆ15æ—¥',
                    doctor_name: 'ç”°ä¸­åŒ»å¸«',
                    next_exam_date: '2024å¹´2æœˆ15æ—¥',
                    care_level: 'è¦ä»‹è­·3',
                    primary_disease: 'é«˜è¡€åœ§ç—‡ã€ç³–å°¿ç—…ã€èªçŸ¥ç—‡',
                    medical_content: 'æœ¬æ—¥ã®è¨ºå¯Ÿã§ã¯ã€è¡€åœ§ã¯130/80mmHgã¨å®‰å®šã€‚\nè¡€ç³–å€¤ã‚‚è‰¯å¥½ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚\nèªçŸ¥æ©Ÿèƒ½ã«ã¤ã„ã¦ã¯ã€è»½åº¦ã®è¨˜æ†¶éšœå®³ãŒè¦‹ã‚‰ã‚Œã¾ã™ãŒã€æ—¥å¸¸ç”Ÿæ´»ã«å¤§ããªæ”¯éšœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nå‡¦æ–¹è–¬ã®ç¶™ç¶šã¨ç”Ÿæ´»æŒ‡å°ã‚’è¡Œã„ã¾ã—ãŸã€‚',
                    advices: ['hypertension', 'diabetes', 'dementia', 'fall_prevention'],
                    generated_date: new Date().toLocaleString('ja-JP')
                };
            },

            // åˆæœŸåŒ–å‡¦ç†
            init: function() {
                console.log('[KyotakuReportTemplate.init] åˆæœŸåŒ–å‡¦ç†é–‹å§‹');

                // LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§é©ç”¨
                const reportData = this.loadFromLocalStorage();
                if (reportData) {
                    console.log('[KyotakuReportTemplate.init] âœ… LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ã—ã¾ã™');
                    console.log('[KyotakuReportTemplate.init] ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: AIå ±å‘Šæ›¸ç”Ÿæˆç”»é¢');
                    this.applyData(reportData);
                } else {
                    console.log('[KyotakuReportTemplate.init] âš ï¸ LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

                    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    const urlParams = new URLSearchParams(window.location.search);
                    const patientId = urlParams.get('patientId');
                    if (patientId) {
                        console.warn('[KyotakuReportTemplate.init] âš ï¸ URLã«patientIdãŒã‚ã‚Šã¾ã™ãŒã€LocalStorageãŒæ¨å¥¨ã•ã‚Œã¾ã™');
                        console.warn('[KyotakuReportTemplate.init] âš ï¸ patientId:', patientId);
                    } else {
                        console.log('[KyotakuReportTemplate.init] â„¹ï¸ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚ã‚ã‚Šã¾ã›ã‚“ï¼ˆæ­£å¸¸ï¼‰');
                    }

                    console.error('[KyotakuReportTemplate.init] âŒ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ai_report.htmlã‹ã‚‰å ±å‘Šæ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                }

                // å°åˆ·ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                window.addEventListener('afterprint', () => {
                    // å°åˆ·å¾Œã«LocalStorageã‚’ã‚¯ãƒªã‚¢
                    this.clearLocalStorage();
                });

                // ç·¨é›†æ©Ÿèƒ½ã®åˆæœŸåŒ–
                this.initEditMode();
            },

            // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆv2.1.1 - ã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰
            dataManager: {
                // å˜ä¸€ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‡ªå‹•ä¿å­˜ï¼‰
                current: {},

                // åˆæœŸåŒ–
                init: function() {
                    try {
                        const storedData = localStorage.getItem('kyotakuReportData');
                        this.current = storedData ? JSON.parse(storedData) : {};
                        console.log('[DataManager] ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†:', this.current);
                    } catch (error) {
                        console.error('[DataManager] ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                        this.current = {};
                    }
                },

                // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãä¿å­˜ï¼ˆ300msé…å»¶ï¼‰
                debouncedSave: debounce(function() {
                    try {
                        localStorage.setItem('kyotakuReportData', JSON.stringify(window.KyotakuReportTemplate.dataManager.current));
                        window.KyotakuReportTemplate.updateSaveStatus('è‡ªå‹•ä¿å­˜æ¸ˆã¿');
                        console.log('[DataManager] è‡ªå‹•ä¿å­˜å®Œäº†');
                    } catch (error) {
                        console.error('[DataManager] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        window.KyotakuReportTemplate.updateSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
                    }
                }, 300),

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜ï¼‰
                updateField: function(field, value) {
                    this.current[field] = value;
                    this.debouncedSave();
                    console.log('[DataManager] ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°:', field, '=', value);
                },

                // ç¾åœ¨ã®å€¤ã‚’å–å¾—
                getValue: function(field) {
                    return this.current[field] || '';
                },

                // ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’å–å¾—
                getData: function() {
                    return {...this.current};
                },

                // ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’è¨­å®šï¼ˆAIç”Ÿæˆæ™‚ï¼‰
                setData: function(data) {
                    this.current = {...data};
                    this.debouncedSave();
                    console.log('[DataManager] ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’è¨­å®š:', this.current);
                },

                // ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°
                updateAdvices: function(advices) {
                    this.current.advices = advices;
                    this.debouncedSave();
                    console.log('[DataManager] ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°:', advices);
                },

                // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ç¶­æŒï¼‰
                saveEdit: function(field, value) {
                    this.updateField(field, value);
                },

                saveOriginal: function(data) {
                    this.setData(data);
                },

                saveAdvices: function(advices) {
                    this.updateAdvices(advices);
                },

                // ãƒªã‚»ãƒƒãƒˆï¼ˆAIå†ç”Ÿæˆã‚’ä¿ƒã™ï¼‰
                reset: function() {
                    if (confirm('AIç”Ÿæˆã‚’ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                        // å…ƒã®AIå ±å‘Šæ›¸ç”Ÿæˆãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                        window.close();
                        return true;
                    }
                    return false;
                },

                // æ—§ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ï¼ˆç§»è¡Œã®ãŸã‚ï¼‰
                loadData: function() {
                    // ç§»è¡Œå‡¦ç†ã§æ—¢ã«å‡¦ç†æ¸ˆã¿ãªã®ã§ä½•ã‚‚ã—ãªã„
                    console.log('[DataManager] loadData() ã¯ç§»è¡Œå‡¦ç†ã§å‡¦ç†æ¸ˆã¿ã§ã™');
                }
            },

            // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
            adviceMaster: {
                hypertension: {
                    label: 'é«˜è¡€åœ§ç”Ÿæ´»æŒ‡å°',
                    content: 'æ¸›å¡©é£Ÿã‚„é©åº¦ãªé‹å‹•ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚'
                },
                diabetes: {
                    label: 'ç³–å°¿ç—…ç”Ÿæ´»æŒ‡å°',
                    content: 'é–“é£Ÿã‚’æ§ãˆã‚‹ã‚ˆã†ã«ã€‚æœè–¬ä¸­ã®æ–¹ã¯ä½è¡€ç³–ç—‡çŠ¶ã«ã‚‚è¦æ³¨æ„ã€‚'
                },
                kidney: {
                    label: 'è…è‡“ç—…ç”Ÿæ´»æŒ‡å°',
                    content: 'è¡€åœ§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€ãŸã‚“ã±ãè³ªåˆ¶é™ã€ã‚«ãƒªã‚¦ãƒ ã®å¤šã„é£Ÿã¹ç‰©ã‚’æ§ãˆã‚‹ã‚ˆã†ã«ã€‚'
                },
                lipid: {
                    label: 'è„‚è³ªä»£è¬ç•°å¸¸ç—‡',
                    content: 'é£Ÿäº‹ãƒãƒ©ãƒ³ã‚¹ã‚’è‰¯ãã—ã€é‹å‹•ã‚’ã™ã‚‹ã‚ˆã†ã«ã€‚'
                },
                dementia: {
                    label: 'ç‰©å¿˜ã‚ŒæŒ‡å°',
                    content: 'æœè–¬ã®è¦‹å®ˆã‚Šãªã©ç´°ã‹ã„ä»‹è­·ã«ã¦å¯¾å¿œã€‚æ°—åˆ†ã®å¤‰åŒ–ãªã©ã«ç•™æ„ã—ã¾ã—ã‚‡ã†ã€‚'
                },
                fall_prevention: {
                    label: 'è»¢å€’äºˆé˜²æŒ‡å°',
                    content: 'æ—¥å¸¸ç”Ÿæ´»ã®ä¸­ã§æ­©è¡Œè¨“ç·´ã‚’ã—ã€è»¢å€’ã«ååˆ†æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚'
                },
                bedridden: {
                    label: 'å¯ãŸãã‚ŠæŒ‡å°',
                    content: 'æ‹˜ç¸®äºˆé˜²ã€è¤¥ç˜¡é˜²æ­¢ã€é•·æ™‚é–“åŒã˜å§¿å‹¢ã‚’å–ã‚‰ãªã„ã‚ˆã†ã«ã€‚'
                },
                malnutrition: {
                    label: 'ä½æ „é¤ŠæŒ‡å°',
                    content: 'ä½æ „é¤Šã«å¯¾ã—ã¦ã€æ „é¤Šå‰¤ã®è£œé£Ÿã‚’æŒ‡å°ã€‚'
                },
                aspiration: {
                    label: 'èª¤åš¥é˜²æ­¢æŒ‡å°',
                    content: 'åš¥ä¸‹èƒ½åŠ›ã«ã‚ã£ãŸé£Ÿäº‹å½¢çŠ¶ã‚’å·¥å¤«ã—ã€é£Ÿäº‹ã¯ã‚†ã£ãã‚Šæ‘‚ã‚Šã¾ã—ã‚‡ã†ã€‚'
                }
            },

            // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
            adviceSelector: {
                maxSelection: 3,
                selectedAdvices: [],
                dropdownOpen: false,

                // åˆæœŸåŒ–
                init: function() {
                    console.log('[AdviceSelector] åˆæœŸåŒ–é–‹å§‹');
                    this.loadSelectedAdvices();
                    this.setupEventListeners();
                    this.renderDropdownOptions();
                    this.renderTags();
                    this.updateAdviceDisplay();
                },

                // é¸æŠæ¸ˆã¿ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰
                loadSelectedAdvices: function() {
                    // dataManagerã‹ã‚‰æ—¢å­˜ã®é¸æŠã‚’å–å¾—
                    const advices = window.KyotakuReportTemplate.dataManager.advices;
                    if (advices && advices.length > 0) {
                        this.selectedAdvices = advices;
                    } else {
                        // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‹ã‚‰åˆæœŸå€¤ã‚’ä½œæˆ
                        const visibleAdvices = document.querySelectorAll('.advice-item[style*="flex"]');
                        visibleAdvices.forEach((element, index) => {
                            const key = element.getAttribute('data-advice');
                            if (key && window.KyotakuReportTemplate.adviceMaster[key]) {
                                this.selectedAdvices.push({
                                    key: key,
                                    label: window.KyotakuReportTemplate.adviceMaster[key].label,
                                    content: window.KyotakuReportTemplate.adviceMaster[key].content,
                                    customContent: null,
                                    order: index
                                });
                            }
                        });
                    }
                },

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                setupEventListeners: function() {
                    const searchInput = document.querySelector('.advice-search');
                    const dropdownList = document.querySelector('.advice-dropdown-list');

                    if (searchInput) {
                        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‹ã
                        searchInput.addEventListener('focus', () => {
                            this.openDropdown();
                        });

                        // æ¤œç´¢å…¥åŠ›
                        searchInput.addEventListener('input', (e) => {
                            this.filterOptions(e.target.value);
                        });

                        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                        searchInput.addEventListener('keydown', (e) => {
                            this.handleKeyboardNavigation(e);
                        });
                    }

                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.advice-dropdown-wrapper')) {
                            this.closeDropdown();
                        }
                    });
                },

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
                renderDropdownOptions: function() {
                    const dropdownList = document.querySelector('.advice-dropdown-list');
                    if (!dropdownList) return;

                    dropdownList.innerHTML = '';

                    Object.entries(window.KyotakuReportTemplate.adviceMaster).forEach(([key, data]) => {
                        const isSelected = this.selectedAdvices.find(a => a.key === key);
                        const isDisabled = !isSelected && this.selectedAdvices.length >= this.maxSelection;

                        const option = document.createElement('div');
                        option.className = 'advice-option';
                        option.setAttribute('data-key', key);
                        option.setAttribute('role', 'option');
                        option.tabIndex = -1;

                        if (isSelected) {
                            option.classList.add('selected');
                            option.setAttribute('aria-selected', 'true');
                        } else if (isDisabled) {
                            option.classList.add('disabled');
                            option.setAttribute('aria-disabled', 'true');
                        }

                        option.innerHTML = `
                            <div class="advice-option-label">${data.label}</div>
                            <div class="advice-option-content">${data.content}</div>
                        `;

                        if (!isSelected && !isDisabled) {
                            option.addEventListener('click', () => {
                                this.addAdvice(key);
                            });
                        }

                        dropdownList.appendChild(option);
                    });
                },

                // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¿½åŠ 
                addAdvice: function(key) {
                    if (this.selectedAdvices.length >= this.maxSelection) {
                        this.showMessage('æœ€å¤§3ã¤ã¾ã§é¸æŠå¯èƒ½ã§ã™');
                        return;
                    }

                    const adviceData = window.KyotakuReportTemplate.adviceMaster[key];
                    if (!adviceData) return;

                    const advice = {
                        key: key,
                        label: adviceData.label,
                        content: adviceData.content,
                        customContent: null,
                        order: this.selectedAdvices.length
                    };

                    this.selectedAdvices.push(advice);
                    this.renderTags();
                    this.renderDropdownOptions();
                    this.updateCounter();
                    this.updateAdviceDisplay();
                    this.saveToDataManager();

                    // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                    const searchInput = document.querySelector('.advice-search');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                },

                // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å‰Šé™¤
                removeAdvice: function(index) {
                    this.selectedAdvices.splice(index, 1);
                    this.reorderAdvices();
                    this.renderTags();
                    this.renderDropdownOptions();
                    this.updateCounter();
                    this.updateAdviceDisplay();
                    this.saveToDataManager();
                },

                // é †åºã‚’å†è¨­å®š
                reorderAdvices: function() {
                    this.selectedAdvices.forEach((advice, index) => {
                        advice.order = index;
                    });
                },

                // ã‚¿ã‚°ã‚’è¡¨ç¤º
                renderTags: function() {
                    const container = document.querySelector('.selected-advice-tags');
                    if (!container) return;

                    container.innerHTML = '';

                    this.selectedAdvices.forEach((advice, index) => {
                        const tag = document.createElement('div');
                        tag.className = 'advice-tag';
                        tag.innerHTML = `
                            <span class="tag-text">${advice.label}</span>
                            <button class="tag-remove" aria-label="${advice.label}ã‚’å‰Šé™¤">Ã—</button>
                        `;

                        const removeBtn = tag.querySelector('.tag-remove');
                        removeBtn.addEventListener('click', () => {
                            this.removeAdvice(index);
                        });

                        container.appendChild(tag);
                    });
                },

                // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
                updateCounter: function() {
                    const counterCurrent = document.querySelector('.counter-current');
                    const counterElement = document.querySelector('.advice-counter');
                    const searchInput = document.querySelector('.advice-search');

                    if (counterCurrent) {
                        counterCurrent.textContent = this.selectedAdvices.length;
                    }

                    if (counterElement) {
                        if (this.selectedAdvices.length >= this.maxSelection) {
                            counterElement.classList.add('max-reached');
                            if (searchInput) {
                                searchInput.disabled = true;
                                searchInput.placeholder = 'æœ€å¤§3ã¤ã¾ã§é¸æŠæ¸ˆã¿';
                            }
                        } else {
                            counterElement.classList.remove('max-reached');
                            if (searchInput) {
                                searchInput.disabled = false;
                                searchInput.placeholder = 'ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ã¾ãŸã¯é¸æŠ...';
                            }
                        }
                    }
                },

                // ã‚¢ãƒ‰ãƒã‚¤ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                updateAdviceDisplay: function() {
                    // ã™ã¹ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’éè¡¨ç¤º
                    document.querySelectorAll('.advice-item').forEach(item => {
                        item.style.display = 'none';
                    });

                    // é¸æŠã•ã‚ŒãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º
                    this.selectedAdvices.forEach(advice => {
                        const element = document.querySelector(`[data-advice="${advice.key}"]`);
                        if (element) {
                            element.style.display = 'flex';
                            element.style.order = advice.order;

                            // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
                            if (advice.customContent) {
                                const contentEl = element.querySelector('.advice-content');
                                if (contentEl) {
                                    contentEl.textContent = advice.customContent;
                                }
                            }
                        }
                    });
                },

                // DataManagerã«ä¿å­˜
                saveToDataManager: function() {
                    window.KyotakuReportTemplate.dataManager.saveAdvices(this.selectedAdvices);
                },

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‹ã
                openDropdown: function() {
                    const dropdownList = document.querySelector('.advice-dropdown-list');
                    const searchInput = document.querySelector('.advice-search');

                    if (this.selectedAdvices.length >= this.maxSelection) {
                        return;
                    }

                    if (dropdownList) {
                        dropdownList.style.display = 'block';
                        this.dropdownOpen = true;
                    }

                    if (searchInput) {
                        searchInput.setAttribute('aria-expanded', 'true');
                    }
                },

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
                closeDropdown: function() {
                    const dropdownList = document.querySelector('.advice-dropdown-list');
                    const searchInput = document.querySelector('.advice-search');

                    if (dropdownList) {
                        dropdownList.style.display = 'none';
                        this.dropdownOpen = false;
                    }

                    if (searchInput) {
                        searchInput.setAttribute('aria-expanded', 'false');
                    }
                },

                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                filterOptions: function(query) {
                    const options = document.querySelectorAll('.advice-option');
                    const lowerQuery = query.toLowerCase();

                    options.forEach(option => {
                        const label = option.querySelector('.advice-option-label').textContent;
                        const content = option.querySelector('.advice-option-content').textContent;

                        if (label.toLowerCase().includes(lowerQuery) ||
                            content.toLowerCase().includes(lowerQuery)) {
                            option.style.display = 'block';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                },

                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                handleKeyboardNavigation: function(e) {
                    const options = document.querySelectorAll('.advice-option:not(.selected):not(.disabled)');
                    const visibleOptions = Array.from(options).filter(o => o.style.display !== 'none');

                    if (visibleOptions.length === 0) return;

                    let currentIndex = -1;
                    const focusedOption = document.querySelector('.advice-option:focus');
                    if (focusedOption) {
                        currentIndex = visibleOptions.indexOf(focusedOption);
                    }

                    switch(e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            currentIndex = (currentIndex + 1) % visibleOptions.length;
                            visibleOptions[currentIndex].focus();
                            break;

                        case 'ArrowUp':
                            e.preventDefault();
                            currentIndex = currentIndex - 1 < 0 ? visibleOptions.length - 1 : currentIndex - 1;
                            visibleOptions[currentIndex].focus();
                            break;

                        case 'Enter':
                            e.preventDefault();
                            if (focusedOption) {
                                const key = focusedOption.getAttribute('data-key');
                                this.addAdvice(key);
                            }
                            break;

                        case 'Escape':
                            e.preventDefault();
                            this.closeDropdown();
                            break;
                    }
                },

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                showMessage: function(message) {
                    window.KyotakuReportTemplate.showValidationMessage(message);
                }
            },

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
            initEditMode: function() {
                console.log('[EditMode] åˆæœŸåŒ–é–‹å§‹');

                // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
                this.dataManager.init();

                // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
                this.setupEditControls();

                // ç·¨é›†å¯èƒ½è¦ç´ ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                this.markEditableFields();

                // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®åˆæœŸåŒ–
                this.adviceSelector.init();

                console.log('[EditMode] åˆæœŸåŒ–å®Œäº†');
            },

            // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            extractCurrentData: function() {
                const data = {};
                document.querySelectorAll('[data-field]').forEach(element => {
                    const field = element.getAttribute('data-field');
                    data[field] = element.textContent.trim();
                });
                return data;
            },

            // ç·¨é›†å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            markEditableFields: function() {
                document.querySelectorAll('[data-field]').forEach(element => {
                    const field = element.getAttribute('data-field');
                    // periodä»¥å¤–ã‚’ç·¨é›†å¯èƒ½ã«
                    if (field !== 'period') {
                        element.classList.add('editable-field');
                    }
                });

                // é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã¯åˆ¥ã‚¯ãƒ©ã‚¹
                const longFields = ['medical_content', 'advice_text'];
                longFields.forEach(field => {
                    const element = document.querySelector(`[data-field="${field}"]`);
                    if (element) {
                        element.classList.add('content-area');
                    }
                });
            },

            // ç·¨é›†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¨­å®š
            setupEditControls: function() {
                const toggleBtn = document.getElementById('toggleEditMode');
                const saveBtn = document.getElementById('saveChanges');

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ãƒˆã‚°ãƒ«
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        this.toggleEditMode();
                    });
                }

                // ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå°†æ¥ã®DBä¿å­˜ç”¨ï¼‰
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        this.saveAllEdits();
                    });
                }
            },

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡æ›¿
            isEditMode: false,
            toggleEditMode: function() {
                this.isEditMode = !this.isEditMode;
                const toggleBtn = document.getElementById('toggleEditMode');
                const saveBtn = document.getElementById('saveChanges');
                const editText = toggleBtn.querySelector('.edit-text');
                const adviceSelector = document.querySelector('.advice-selector-container');

                if (this.isEditMode) {
                    console.log('[EditMode] ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON');

                    // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
                    toggleBtn.classList.add('active');
                    editText.textContent = 'é–²è¦§ãƒ¢ãƒ¼ãƒ‰';
                    // ä¿å­˜ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤ºï¼ˆå‰Šé™¤ï¼‰

                    // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                    if (adviceSelector) {
                        adviceSelector.style.display = 'block';
                        this.adviceSelector.updateCounter();
                    }

                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç·¨é›†å¯èƒ½ã«
                    this.enableEditing();

                } else {
                    console.log('[EditMode] ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFF');

                    // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
                    toggleBtn.classList.remove('active');
                    editText.textContent = 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
                    // ä¿å­˜ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤ºï¼ˆå‰Šé™¤ï¼‰

                    // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
                    if (adviceSelector) {
                        adviceSelector.style.display = 'none';
                        this.adviceSelector.closeDropdown();
                    }

                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç·¨é›†ä¸å¯ã«
                    this.disableEditing();
                }
            },

            // ç·¨é›†ã‚’æœ‰åŠ¹åŒ–
            enableEditing: function() {
                document.querySelectorAll('.editable-field').forEach(element => {
                    const field = element.getAttribute('data-field');

                    // contenteditableå±æ€§ã‚’è¿½åŠ 
                    element.setAttribute('contenteditable', 'true');

                    // IMEå¯¾å¿œã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                    this.addEditEventListeners(element, field);
                });
            },

            // ç·¨é›†ã‚’ç„¡åŠ¹åŒ–
            disableEditing: function() {
                document.querySelectorAll('.editable-field').forEach(element => {
                    element.setAttribute('contenteditable', 'false');
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯æ®‹ã™ï¼ˆå†åº¦æœ‰åŠ¹åŒ–æ™‚ã®ãŸã‚ï¼‰
                });
            },

            // ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
            addEditEventListeners: function(element, field) {
                let isComposing = false;
                let originalValue = element.textContent;

                // IMEé–‹å§‹
                element.addEventListener('compositionstart', () => {
                    isComposing = true;
                });

                // IMEçµ‚äº†
                element.addEventListener('compositionend', (e) => {
                    isComposing = false;
                    setTimeout(() => {
                        const value = this.sanitizeText(e.target.innerText || e.target.textContent, field);
                        this.dataManager.updateField(field, value);
                    }, 100);
                });

                // é€šå¸¸ã®å…¥åŠ›
                element.addEventListener('input', (e) => {
                    if (!isComposing) {
                        const value = this.sanitizeText(e.target.innerText || e.target.textContent, field);
                        this.dataManager.updateField(field, value);
                    }
                });

                // ãƒšãƒ¼ã‚¹ãƒˆå‡¦ç†
                element.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    const sanitized = this.sanitizeText(text, field);
                    document.execCommand('insertText', false, sanitized);
                });

                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚
                element.addEventListener('focus', () => {
                    originalValue = element.textContent;
                });

                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                element.addEventListener('blur', () => {
                    const value = element.textContent.trim();
                    if (this.isRequiredField(field) && !value) {
                        element.classList.add('validation-error');
                        this.showValidationMessage(`${this.getFieldLabel(field)}ã¯å¿…é ˆé …ç›®ã§ã™`);
                        setTimeout(() => {
                            element.textContent = originalValue;
                            element.classList.remove('validation-error');
                        }, 2000);
                    }
                });
            },

            // ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒ‹ã‚¿ã‚¤ã‚º
            sanitizeText: function(text, field) {
                // HTMLã‚¿ã‚°ã‚’é™¤å»
                const tmp = document.createElement('div');
                tmp.innerHTML = text;
                let cleaned = tmp.textContent || tmp.innerText || '';

                // æ”¹è¡Œã®æ­£è¦åŒ–ï¼ˆé•·ã„ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯ä¿æŒï¼‰
                if (field === 'medical_content' || field === 'advice_text') {
                    // éå‰°ãªæ”¹è¡Œã‚’åˆ¶é™
                    cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
                } else {
                    // å˜ä¸€è¡Œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ”¹è¡Œã‚’é™¤å»
                    cleaned = cleaned.replace(/\n/g, ' ');
                }

                // ä½™åˆ†ãªç©ºç™½ã‚’é™¤å»
                cleaned = cleaned.replace(/\s+/g, ' ').trim();

                return cleaned;
            },

            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
            isRequiredField: function(field) {
                const required = ['patient_name', 'exam_date', 'medical_content'];
                return required.includes(field);
            },

            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ©ãƒ™ãƒ«å–å¾—
            getFieldLabel: function(field) {
                const labels = {
                    patient_name: 'æ‚£è€…å',
                    exam_date: 'è¨ºå¯Ÿæ—¥',
                    medical_content: 'è¨ºç™‚å†…å®¹'
                };
                return labels[field] || field;
            },

            // ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateSaveStatus: function(message) {
                const statusElement = document.getElementById('saveStatus');
                const statusText = statusElement.querySelector('.status-text');
                const statusIcon = statusElement.querySelector('.status-icon');

                if (!message) {
                    statusElement.style.display = 'none';
                    return;
                }

                statusElement.style.display = 'flex';
                statusText.textContent = message;

                if (message === 'ä¿å­˜ä¸­...') {
                    statusElement.classList.add('saving');
                    statusElement.classList.remove('error');
                    statusIcon.textContent = 'â³';
                } else if (message.includes('ã‚¨ãƒ©ãƒ¼')) {
                    statusElement.classList.add('error');
                    statusElement.classList.remove('saving');
                    statusIcon.textContent = 'âŒ';
                } else if (message.includes('PDFã‚’ä¿å­˜')) {
                    statusElement.classList.remove('saving', 'error');
                    statusIcon.textContent = 'âœ…';
                } else {
                    statusElement.classList.remove('saving', 'error');
                    statusIcon.textContent = '';
                }
            },

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            showValidationMessage: function(message) {
                // ãƒˆãƒ¼ã‚¹ãƒˆé¢¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const toast = document.createElement('div');
                toast.className = 'validation-toast';
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 4px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    z-index: 2000;
                    animation: slideIn 0.3s ease;
                `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },


            // ç”»é¢ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            collectReportData: function() {
                const data = {
                    // æ‚£è€…åŸºæœ¬æƒ…å ±
                    patientId: document.querySelector('[data-field="patient_id"]')?.textContent?.trim() || '',
                    patientName: document.querySelector('[data-field="patient_name"]')?.textContent?.trim() || '',
                    birthdate: document.querySelector('[data-field="birthdate"]')?.textContent?.trim() || '',
                    age: document.querySelector('[data-field="age"]')?.textContent?.trim() || '',
                    address: document.querySelector('[data-field="address"]')?.textContent?.trim() || '',

                    // ã‚±ã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æƒ…å ±
                    cmName: document.querySelector('[data-field="cm_name"]')?.textContent?.trim() || '',
                    officeName: document.querySelector('[data-field="office_name"]')?.textContent?.trim() || '',
                    officeAddress: document.querySelector('[data-field="office_address"]')?.textContent?.trim() || '',

                    // è¨ºç™‚æƒ…å ±
                    examDate: document.querySelector('[data-field="exam_date"]')?.textContent?.trim() || '',
                    doctorName: document.querySelector('[data-field="doctor_name"]')?.textContent?.trim() || '',
                    nextExamDate: document.querySelector('[data-field="next_exam_date"]')?.textContent?.trim() || '',
                    careLevel: document.querySelector('[data-field="care_level"]')?.textContent?.trim() || '',
                    primaryDisease: document.querySelector('[data-field="primary_disease"]')?.textContent?.trim() || '',

                    // å ±å‘Šå†…å®¹
                    content: document.querySelector('[data-field="medical_content"]')?.textContent?.trim() || '',
                    observations: document.querySelector('[data-field="advice_text"]')?.textContent?.trim() || '',

                    // æœŸé–“æƒ…å ±
                    periodStart: document.querySelector('[data-field="period_start"]')?.textContent?.trim() || '',
                    periodEnd: document.querySelector('[data-field="period_end"]')?.textContent?.trim() || '',

                    // ãƒ¡ã‚¿æƒ…å ±
                    author: 'åŒ»ç™‚å¾“äº‹è€…',
                    facility: 'ãŸã™ããƒ›ãƒ¼ãƒ ã‚¯ãƒªãƒ‹ãƒƒã‚¯'
                };

                // æ‚£è€…IDã‹ã‚‰æ•°å€¤éƒ¨åˆ†ã®ã¿ã‚’æŠ½å‡º
                const patientIdMatch = data.patientId.match(/\d+/);
                if (patientIdMatch) {
                    data.patient_id = patientIdMatch[0];
                }

                return data;
            },

            // PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã®HTMLã‚’å–å¾—
            exportReportHtml: function() {
                // DOMå…¨ä½“ã‚’è¤‡è£½
                const clonedDocument = document.documentElement.cloneNode(true);

                // ä¸è¦ãªè¦ç´ ã‚’å‰Šé™¤
                const elementsToRemove = clonedDocument.querySelectorAll([
                    '.no-print',
                    '.edit-controls',
                    '.save-status',
                    '.save-button',
                    '.edit-button',
                    '.print-button',
                    '[data-advice-selector]',
                    '.advice-selector'
                ].join(','));

                elementsToRemove.forEach(element => {
                    element.remove();
                });

                // ã™ã¹ã¦ã®scriptã‚¿ã‚°ã‚’å‰Šé™¤
                const scripts = clonedDocument.querySelectorAll('script');
                scripts.forEach(script => {
                    script.remove();
                });

                // contenteditableå±æ€§ã‚’å‰Šé™¤
                const editableElements = clonedDocument.querySelectorAll('[contenteditable]');
                editableElements.forEach(element => {
                    element.removeAttribute('contenteditable');
                });

                // ã‚¹ã‚¿ã‚¤ãƒ«ã§cursorãŒpointerã‚„textã«ãªã£ã¦ã„ã‚‹è¦ç´ ã‚’ä¿®æ­£
                const interactiveElements = clonedDocument.querySelectorAll('[style*="cursor"]');
                interactiveElements.forEach(element => {
                    const style = element.getAttribute('style');
                    if (style) {
                        element.setAttribute('style', style.replace(/cursor:\s*[^;]+;?/g, ''));
                    }
                });

                // HTMLå…¨ä½“ã‚’æ–‡å­—åˆ—ã¨ã—ã¦å–å¾—
                const htmlString = '<!DOCTYPE html>\n' + clonedDocument.outerHTML;

                return htmlString;
            },

            // ã™ã¹ã¦ã®ç·¨é›†ã‚’ä¿å­˜ï¼ˆDBä¿å­˜ã¨PDFç”Ÿæˆï¼‰
            saveAllEdits: async function() {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!this.validateBeforeSave()) {
                    return;
                }

                // ä¿å­˜ä¸­ã®è¡¨ç¤º
                this.updateSaveStatus('ä¿å­˜ä¸­...');

                try {
                    // ç”»é¢ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                    const reportData = this.collectReportData();

                    // PDFç”¨ã®HTMLã‚’å–å¾—
                    const htmlContent = this.exportReportHtml();

                    console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', reportData);
                    console.log('HTMLã‚µã‚¤ã‚º:', htmlContent.length, 'bytes');

                    // APIã«é€ä¿¡
                    const response = await fetch('http://localhost:3000/api/ai/save-kyotaku-report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            reportData: reportData,
                            patientId: reportData.patient_id || reportData.patientId,
                            html: htmlContent
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // æˆåŠŸ
                        this.updateSaveStatus('âœ… PDFã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                        console.log('ä¿å­˜æˆåŠŸ:', result.data);

                        // LocalStorageã‚’ã‚¯ãƒªã‚¢
                        this.clearLocalStorage();

                        // 1ç§’å¾Œã«æ‚£è€…é¸æŠç”»é¢ã«é·ç§»ï¼ˆä¿å­˜æˆåŠŸãƒ•ãƒ©ã‚°ä»˜ãï¼‰
                        setTimeout(() => {
                            window.location.href = '/ai_report.html?saved=true';
                        }, 1000);
                    } else {
                        throw new Error(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateSaveStatus('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);

                    // 5ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’éè¡¨ç¤º
                    setTimeout(() => {
                        this.updateSaveStatus('');
                    }, 5000);
                }
            },

            // ä¿å­˜å‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            validateBeforeSave: function() {
                const errors = [];
                const required = ['patient_name', 'exam_date', 'medical_content'];

                required.forEach(field => {
                    const element = document.querySelector(`[data-field="${field}"]`);
                    if (element && !element.textContent.trim()) {
                        errors.push(field);
                        element.classList.add('validation-error');
                    }
                });

                if (errors.length > 0) {
                    this.showValidationMessage('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    setTimeout(() => {
                        document.querySelectorAll('.validation-error').forEach(el => {
                            el.classList.remove('validation-error');
                        });
                    }, 3000);
                    return false;
                }

                return true;
            }
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[kyotaku_report_template.html] DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«');
            console.log('[kyotaku_report_template.html] report_generator.js ã®çŠ¶æ…‹:',
                        window.reportGenerator ? 'èª­ã¿è¾¼ã¿æ¸ˆã¿' : 'æœªèª­ã¿è¾¼ã¿');
            window.KyotakuReportTemplate.init();
        });
    </script>
</body>
</html>