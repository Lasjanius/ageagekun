# システム概要

## プロダクト名
**Ageagekun (あげあげくん)** - 医療文書自動アップロードシステム

## ミッション
在宅医療現場における書類管理業務を自動化し、医療スタッフが本来の医療業務に集中できる環境を実現する。

## システム構成図

```
┌─────────────────────────────────────────────┐
│           モバカルネット（外部システム）           │
│              電子カルテシステム                   │
└─────────────────────────────────────────────┘
                        ↑
                   自動アップロード
                        ↑
┌─────────────────────────────────────────────┐
│         Power Automate Desktop (PAD)         │
│              RPA自動化エンジン                   │
└─────────────────────────────────────────────┘
                        ↑
                   DB監視・タスク取得
                        ↑
┌─────────────────────────────────────────────┐
│           PostgreSQL Database                │
│    患者情報・文書管理・処理キュー                  │
└─────────────────────────────────────────────┘
                        ↑
              WebSocket/REST API
                        ↑
┌─────────────────────────────────────────────┐
│            Backend Server                    │
│         Node.js + Express.js                 │
│      ・API提供 ・AI処理 ・WebSocket           │
└─────────────────────────────────────────────┘
                        ↑
                   HTTP/WebSocket
                        ↑
┌─────────────────────────────────────────────┐
│           Frontend Application               │
│         HTML5 + JavaScript + CSS             │
│      ・UI提供 ・リアルタイム更新               │
└─────────────────────────────────────────────┘
```

## 技術スタック

### フロントエンド
- **言語**: HTML5, CSS3, Vanilla JavaScript
- **通信**: Fetch API, WebSocket
- **UI**: カスタムコンポーネント、レスポンシブデザイン

### バックエンド
- **ランタイム**: Node.js v18+
- **フレームワーク**: Express.js
- **WebSocket**: ws ライブラリ
- **AI**: Azure OpenAI API (gpt-4o-mini, Sweden Central)

### データベース
- **RDBMS**: PostgreSQL 17
- **接続**: pg (node-postgres)
- **認証**: pgpass.conf

### RPA
- **ツール**: Power Automate Desktop
- **連携**: PostgreSQL直接接続（ODBC）

### 開発環境
- **OS**: Windows 11
- **エディタ**: VS Code
- **バージョン管理**: Git

## 主要機能

### 1. 文書自動アップロード
- 未アップロード文書の検出
- バッチ処理によるキュー管理
- PADによる自動アップロード
- リアルタイム進捗表示

### 2. AI報告書生成
- カルテからの自動要約
- 2ステップの簡単操作
- 居宅療養管理指導報告書の生成
- 印刷/PDF保存対応

### 3. データ管理
- 患者情報の正規化管理
- ケアマネージャー情報
- 事業所情報
- 文書履歴管理

## ディレクトリ構造

```
ageagekun/
├── frontend/          # フロントエンド
│   ├── index.html    # メインページ
│   ├── ai_report.html # AI報告書
│   ├── js/           # JavaScript
│   ├── css/          # スタイルシート
│   └── templates/    # HTMLテンプレート
├── backend/          # バックエンド
│   ├── server.js     # メインサーバー
│   ├── routes/       # APIルート
│   ├── controllers/  # コントローラー
│   ├── services/     # サービス層
│   └── config/       # 設定
├── patients/         # 患者別文書
│   └── [patientID]/  # 8桁ID
│       └── uploaded/ # 完了済み
├── schema/           # DB設計
├── docs/             # ドキュメント
│   ├── PRD.md       # 要件定義
│   ├── specifications/ # 仕様書
│   ├── architecture/   # 設計書
│   └── status/         # ステータス
└── logs/            # ログファイル
```

## データフロー

### アップロードフロー
1. ユーザーが「All Upload」ボタンクリック
2. 未アップロード文書をDBから取得
3. 確認画面でユーザー承認
4. rpa_queueにタスク登録
5. PADが定期的にキューを監視
6. PADがモバカルネットにアップロード
7. 完了後、DBとファイルシステムを更新
8. WebSocketでフロントエンドに通知

### AI報告書フロー
1. 患者選択
2. カルテ内容入力
3. AI APIで情報抽出
4. LocalStorageに保存
5. 新タブで報告書表示

## セキュリティ

### 認証・認可
- 現在は内部利用のため認証なし
- 将来的にJWT認証実装予定

### データ保護
- PostgreSQL認証（pgpass.conf）
- APIキーの環境変数管理（.env.local）
- HTTPS化（本番環境）

### アクセス制御
- CORS設定
- ファイルアクセス権限
- SQLインジェクション対策

## パフォーマンス

### 最適化項目
- DB接続プーリング
- インデックス最適化
- WebSocketによるリアルタイム通信
- バッチ処理による効率化

### 監視項目
- API応答時間
- DB接続状態
- RPA処理成功率
- エラー発生率

## 将来の拡張計画

### 短期（3ヶ月以内）
- エラーハンドリング強化
- ログ管理システム
- バックアップ自動化

### 中期（6ヶ月以内）
- 複数施設対応
- ユーザー管理機能
- レポートテンプレート追加

### 長期（1年以内）
- クラウド移行
- モバイルアプリ開発
- 他電子カルテ連携