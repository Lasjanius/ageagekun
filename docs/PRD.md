# Ageagekun プロダクト要件定義書（PRD）

## 📌 概要

**Ageagekun（あげあげくん）** は、在宅医療現場における文書管理業務を自動化するシステムです。Power Automate Desktop（PAD）と連携し、モバカルネット電子カルテシステムへの書類アップロードを自動化します。さらにAIを活用した報告書自動生成機能により、医療スタッフの業務効率を大幅に改善します。

### ビジョン
医療スタッフが本来の医療業務に集中できる環境を実現し、在宅医療の質向上に貢献する。

### ターゲットユーザー
- 在宅医療機関の医師・看護師
- ケアマネージャー
- 医療事務スタッフ

## 📚 仕様書インデックス

### 🎯 主要機能仕様

#### [基本アップロード機能](./specifications/01-core-upload.md)
PADと連動した自動アップロードの中核機能。WebSocketによるリアルタイム進捗表示、キャンセル処理、エラーハンドリングを含む。

#### [AI報告書作成機能](./specifications/02-ai-report.md)
カルテから居宅療養管理指導報告書を自動生成。2ステップのシンプルなフローで、OpenAI GPT-4o-miniを使用した高精度な情報抽出。**v2.1.0より報告書のインライン編集機能とアドバイスセレクター機能を追加**。

### 🏗 システム設計

#### [データベース設計](./specifications/03-database.md)
PostgreSQL 17による正規化されたデータベース構造。患者情報、文書管理、RPA処理キューの詳細設計。

#### [API仕様](./specifications/04-api.md)
RESTful APIエンドポイント、WebSocket通信、エラーハンドリングの完全仕様。

#### [RPA連携仕様](./specifications/05-rpa-queue.md)
Power Automate Desktopとの連携詳細。キュー管理、自律処理フロー、トラブルシューティングガイド。

### 📐 アーキテクチャ

#### [システム概要](./architecture/system-overview.md)
全体アーキテクチャ、技術スタック、データフロー、ディレクトリ構造の俯瞰図。

### 📊 プロジェクト管理

#### [実装ステータス](./status/implementation.md)
開発進捗、実装済み機能、既知の問題、リリースノートの管理。

## 🔑 重要な設計原則

### データ管理
- **正規化**: 第3正規形に準拠したテーブル設計
- **整合性**: 外部キー制約とトリガーによる自動処理
- **履歴保持**: 削除ではなくステータス管理

### セキュリティ
- **認証**: pgpass.confによるDB認証（将来的にJWT実装）
- **暗号化**: APIキーの環境変数管理
- **アクセス制御**: CORS設定による制限

### パフォーマンス
- **リアルタイム**: WebSocketによる即時通知
- **効率化**: バッチ処理とDB接続プーリング
- **最適化**: インデックスによるクエリ高速化

### UX/UI設計（v2.1.0追加）
- **インライン編集**: 画面遷移なしで報告書を直接編集
- **直感的UI**: タグスタイルのアドバイスセレクター
- **アクセシビリティ**: ARIA対応、キーボード操作完全サポート
- **レスポンシブ**: モバイルデバイスでの操作性確保

## 🚀 クイックスタート

### 環境要件
- Node.js 18+
- PostgreSQL 17
- Power Automate Desktop
- Windows 11

### セットアップ手順
1. リポジトリのクローン
2. 依存関係のインストール（`npm install`）
3. データベースの初期化（`schema/create_schema.sql`）
4. 環境変数の設定（`.env.local`）
5. サーバー起動（`npm start`）

### 主要コマンド
```bash
# バックエンド起動
cd backend && npm start

# 開発モード
npm run dev

# データベース接続
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -h localhost -d ageagekun -w
```

## 📈 今後のロードマップ

### Phase 1（完了）✅
- 基本アップロード機能
- AI報告書生成（2ステップフロー）
- WebSocketリアルタイム通信

### Phase 1.5（v2.1.0 - 2025年1月完了）✅
- **インライン編集機能**: 生成後の報告書を直接編集
- **アドバイスセレクター**: 最大3つまでの生活指導を選択
- **日本語IME対応**: 日本語入力の完全サポート
- **データ永続化**: オリジナルと編集データの分離管理
- **ポップアップブロッカー対策**: Open-Firstパターンによる確実な新タブ表示

### Phase 1.6（v2.1.2 - 2025年1月完了）✅
- **データフロー簡略化**: 3層データ管理から1層へのリファクタリング
- **リアルタイム自動保存**: 編集と同時に300ms遅延でLocalStorage保存
- **UX改善**: リセットボタン削除による混乱の排除
- **安全な移行処理**: 既存データを壊さない自動移行機能

### Phase 1.7（v2.2.0 - 2025年9月完了）✅
- **PDF保存機能**: AI生成報告書をPDFとしてローカル保存
- **WYSIWYG PDF生成**: プレビュー画面と完全一致のPDF出力
- **Documents連携**: 保存したPDFをDocumentsテーブルに自動登録
- **自動画面遷移**: 保存成功後に患者選択画面へ自動遷移

### Phase 2（計画中）
- 認証システム実装
- 複数施設対応
- レポートテンプレート管理
- アドバイスのカスタムテキスト編集

### Phase 3（将来）
- クラウド移行
- モバイルアプリ開発
- 他電子カルテ連携
- 音声入力対応

## 📝 ドキュメント管理

このPRDは、プロジェクトの全仕様へのインデックスとして機能します。各詳細仕様は個別のドキュメントに分割され、保守性と可読性を確保しています。

### ドキュメント更新ルール
1. 機能追加時は該当する仕様書を更新
2. 大きな変更はPRD.mdのインデックスも更新
3. 実装完了したら`status/implementation.md`を更新

## 🤝 コントリビューション

プロジェクトへの貢献を歓迎します。新機能提案、バグ報告、ドキュメント改善など、Issueまたはプルリクエストでお知らせください。

---

*最終更新: 2025年9月19日*
*バージョン: 2.2.0*