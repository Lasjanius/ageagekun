# Ageagekun プロダクト要件定義書（PRD）

## 📌 概要

**Ageagekun（あげあげくん）** は、在宅医療現場における文書管理業務を自動化するシステムです。Power Automate Desktop（PAD）と連携し、モバカルネット電子カルテシステムへの書類アップロードを自動化します。さらにAIを活用した報告書自動生成機能により、医療スタッフの業務効率を大幅に改善します。

### ビジョン
医療スタッフが本来の医療業務に集中できる環境を実現し、在宅医療の質向上に貢献する。

### ターゲットユーザー
- 在宅医療機関の医師・看護師
- ケアマネージャー
- 医療事務スタッフ

## 📚 仕様書インデックス

### 🎯 主要機能仕様

#### [基本アップロード機能](./specifications/01-core-upload.md)
PADと連動した自動アップロードの中核機能。WebSocketによるリアルタイム進捗表示、キャンセル処理、エラーハンドリングを含む。**v3.2.0よりドキュメント削除機能とマスターテーブル管理機能を追加**。

#### [AI報告書作成機能](./specifications/02-ai-report-v3.md)
カルテから居宅療養管理指導報告書を自動生成。2ステップのシンプルなフローで、Azure OpenAI (gpt-4o-mini)を使用した高精度な情報抽出。**v2.1.0より報告書のインライン編集機能とアドバイスセレクター機能を追加**。**v2.4.0より患者リストのフィルター・ソート機能と作成履歴管理を追加**。**v3.0.0よりカルテ貼り付けタブ機能と2カラム患者確認画面を追加**。**v3.1.0よりUX改善（高速遷移、誤操作防止）を実施**。**v4.0.0よりAzure OpenAI APIへ完全移行**。

#### [患者管理機能](./specifications/07-patient-management.md)
患者マスターデータの管理機能。**v3.3.0より患者新規登録画面の階層的選択機能を追加**。居宅介護支援事業所とケアマネージャーの依存関係を反映した論理的なUI設計。共通モーダル管理システム（modalManager.js）とマスターデータサービス（masterDataService.js）による統一的なデータ管理。

#### [管理画面機能](./specifications/08-admin-features.md)
統計情報ダッシュボードとマスターデータ管理機能。**v3.4.0よりページ遷移方式の登録画面、改善されたモーダル管理、プルダウン状態保持機能を実装**。

### 🏗 システム設計

#### [データベース設計](./specifications/03-database.md)
PostgreSQL 17による正規化されたデータベース構造。患者情報、文書管理、RPA処理キュー、マスターテーブル（care_offices、care_managers、visiting_nurse_stations）の詳細設計。**v3.3.0でDBschemaドキュメントを最新構造に更新**。

#### [API仕様](./specifications/04-api.md)
RESTful APIエンドポイント、WebSocket通信、エラーハンドリングの完全仕様。

#### [RPA連携仕様](./specifications/05-rpa-queue.md)
Power Automate Desktopとの連携詳細。キュー管理、自律処理フロー、トラブルシューティングガイド。

#### [UI/UXデザイン仕様](./specifications/06-ui-design.md)
モダンSaaS風のデザインシステム。カラーパレット、タイポグラフィ、コンポーネント設計、アクセシビリティ対応。**v2.3.0よりUI全体を洗練化**。

### 📐 アーキテクチャ

#### [システム概要](./architecture/system-overview.md)
全体アーキテクチャ、技術スタック、データフロー、ディレクトリ構造の俯瞰図。

#### フロントエンドモジュール構成（v3.3.0更新）
- **modalManager.js**: モーダルスタック管理、ネストモーダル対応、状態保存機能
- **masterDataService.js**: マスターデータAPI呼び出しの共通化、キャッシュ管理
- **patient-registration.js**: 患者新規登録画面の制御、階層的選択実装
- **admin.js**: 管理画面メインページの制御、統計情報表示

### 📊 プロジェクト管理

#### [実装ステータス](./status/implementation.md)
開発進捗、実装済み機能、既知の問題、リリースノートの管理。

## 🔑 重要な設計原則

### データ管理
- **正規化**: 第3正規形に準拠したテーブル設計
- **整合性**: 外部キー制約とトリガーによる自動処理
- **履歴保持**: 削除ではなくステータス管理

### セキュリティ
- **認証**: pgpass.confによるDB認証（将来的にJWT実装）
- **暗号化**: APIキーの環境変数管理（Azure OpenAI API対応）
- **アクセス制御**: CORS設定による制限
- **本番環境対応**: Azure準拠のセキュアなAI API設定

### パフォーマンス
- **リアルタイム**: WebSocketによる即時通知
- **効率化**: バッチ処理とDB接続プーリング
- **最適化**: インデックスによるクエリ高速化

### UX/UI設計（v2.1.0追加）
- **インライン編集**: 画面遷移なしで報告書を直接編集
- **直感的UI**: タグスタイルのアドバイスセレクター
- **アクセシビリティ**: ARIA対応、キーボード操作完全サポート
- **レスポンシブ**: モバイルデバイスでの操作性確保

## 🚀 クイックスタート

### 環境要件
- Node.js 18+
- PostgreSQL 17
- Power Automate Desktop
- Windows 11

### セットアップ手順
1. リポジトリのクローン
2. 依存関係のインストール（`npm install`）
3. データベースの初期化（`schema/create_schema.sql`）
4. 環境変数の設定（`.env.local`）
5. サーバー起動（`npm start`）

### 主要コマンド
```bash
# バックエンド起動
cd backend && npm start

# 開発モード
npm run dev

# データベース接続
"C:\Program Files\PostgreSQL\17\bin\psql.exe" -U postgres -h localhost -d ageagekun -w
```

## 📈 今後のロードマップ

### Phase 1（完了）✅
- 基本アップロード機能
- AI報告書生成（2ステップフロー）
- WebSocketリアルタイム通信

### Phase 1.5（v2.1.0 - 2025年1月完了）✅
- **インライン編集機能**: 生成後の報告書を直接編集
- **アドバイスセレクター**: 最大3つまでの生活指導を選択
- **日本語IME対応**: 日本語入力の完全サポート
- **データ永続化**: オリジナルと編集データの分離管理
- **ポップアップブロッカー対策**: Open-Firstパターンによる確実な新タブ表示

### Phase 1.6（v2.1.2 - 2025年1月完了）✅
- **データフロー簡略化**: 3層データ管理から1層へのリファクタリング
- **リアルタイム自動保存**: 編集と同時に300ms遅延でLocalStorage保存
- **UX改善**: リセットボタン削除による混乱の排除
- **安全な移行処理**: 既存データを壊さない自動移行機能

### Phase 1.7（v2.2.0 - 2025年9月完了）✅
- **PDF保存機能**: AI生成報告書をPDFとしてローカル保存
- **WYSIWYG PDF生成**: プレビュー画面と完全一致のPDF出力
- **Documents連携**: 保存したPDFをDocumentsテーブルに自動登録
- **自動画面遷移**: 保存成功後に患者選択画面へ自動遷移

### Phase 1.8（v2.3.0 - 2025年9月完了）✅
- **UI洗練化**: モダンSaaS風のデザインへ刷新
- **角丸統一**: 6-12pxの柔らかい角丸に統一
- **グラデーション改善**: 3色グラデーションで奥行き感
- **インタラクション強化**: ホバー・フォーカス状態の改善
- **パフォーマンス最適化**: トランジション個別設定

### Phase 1.9（v3.0.0 - 2025年9月完了）✅
- **カルテ貼り付けタブ機能**: 電子カルテから直接コピー＆ペーストで報告書作成
- **2カラム患者確認画面**: 患者情報の視覚的確認とDB照合
- **患者検索API**: カルテからの患者情報自動抽出と検証
- **書類履歴表示**: 過去のAI生成書類作成履歴を確認画面に表示
- **ワークフロー最適化**: 2つの開始方法による柔軟な業務フロー対応

### Phase 1.10（v3.1.0 - 2025年9月完了）✅
- **UX高速化**: PDF保存後の自動遷移を2秒から1秒に短縮
- **誤操作防止機能**: Step2以降でタブを自動非表示
- **ワークフローの明確化**: タブ制御によるユーザーインターフェースの簡潔性向上
- **データ保護**: 誤クリックによる入力データ損失の防止

### Phase 1.11（v3.2.0 - 2025年9月完了）✅
- **ドキュメント削除機能**: フロントエンドから個別ドキュメントを安全に削除
- **削除確認UI**: 取り消し不可警告付きの確認ダイアログ
- **処理中保護**: RPA処理中のドキュメントは削除不可
- **CASCADE DELETE**: データベース整合性の自動維持
- **リアルタイム同期**: WebSocket経由で全クライアントに即座に反映
- **物理ファイル削除**: データベースとファイルシステムの同期
- **マスターテーブル管理機能**: 管理画面からケアマネージャー、事業所、訪問看護ステーションの追加・編集・削除
- **統計ダッシュボード**: 患者数、書類数、各マスターテーブルの統計情報を一覧表示

### Phase 1.12（v3.3.0 - 2025年9月20日完了）✅
- **患者登録画面の階層的選択**: 居宅介護支援事業所を選択してからケアマネージャーを選択する論理的なUI
- **依存関係の自動制御**: 事業所未選択時はケアマネージャー選択を無効化
- **動的ケアマネージャー取得**: 選択された事業所に所属するケアマネージャーのみを表示
- **誤選択防止**: 事業所未選択時にアラート表示で適切な操作順序を誘導
- **DBschemaドキュメント更新**: 正規化されたデータベース構造を正確に反映
- **UIデザイン統一**:
  - ケア管理情報セクションのドロップダウン幅を統一（固定幅: 500px）
  - 新規登録ボタンのテキストをすべて「新規登録」に統一
- **共通モーダル管理システム実装**:
  - modalManager.js - モーダルのスタック管理、ネストモーダル対応、状態保存機能
  - masterDataService.js - マスターデータAPI呼び出しの共通化、キャッシュ管理
- **管理画面マスターデータ登録機能強化**:
  - 訪問看護ステーション、居宅介護支援事業所、ケアマネージャーの新規登録
  - ネストモーダルによる関連データの連鎖登録
  - リアルタイム統計情報の更新

### Phase 1.13（v3.4.0 - 2025年9月20日完了）✅
- **管理画面のページ遷移方式採用**: マスターデータ登録をモーダルからページ遷移に変更
  - メインタスクは独立ページ、サブタスクはモーダルという適切なUXパターンを採用
  - 共通テンプレートシステム（master-registration.js）による効率的な実装
  - 設定ファイル駆動の動的フォーム生成
- **モーダル管理システムの改善**:
  - z-index問題の根本解決（modal__contentにz-index設定）
  - オーバーレイとコンテンツの適切なスタッキング管理
  - close時のインラインスタイル完全クリア
- **プルダウン状態保持機能**:
  - refreshSelects()の改善により選択状態を維持
  - 非同期処理の競合回避（ポーリング方式）
  - 依存関係のあるプルダウンの確実な復元
- **トースト通知の改善**:
  - 登録完了後の即座のページ遷移（1.5秒待機を削除）
  - URLパラメータによる成功メッセージ受け渡し
  - 管理画面での統一されたトースト表示

### Phase 1.14（v4.0.0 - 2025年9月20日完了）✅
- **Azure OpenAI APIへの完全移行**: 本番環境対応のセキュアなAI基盤
  - Sweden Centralリージョンのgpt-4o-miniモデルを使用
  - OpenAI APIからの完全移行でセキュリティ強化
  - 環境変数の再構成（AZURE_OPENAI_API_KEY、AZURE_OPENAI_ENDPOINT等）
  - API互換性の維持によるシームレスな移行
- **テストスクリプトの追加**:
  - Azure OpenAI接続テスト（test-azure-openai.js）
  - レポート生成機能テスト（test-report-generation.js）
  - Hello Worldミームテストと JSON形式応答テストを含む包括的検証
- **aiService.jsの改修**:
  - Azure OpenAI用の設定に完全対応
  - プロバイダー切り替え可能な柔軟な設計
  - エラーハンドリングの改善

### Phase 2（計画中）
- 認証システム実装
- 複数施設対応
- レポートテンプレート管理
- アドバイスのカスタムテキスト編集

### Phase 3（将来）
- クラウド移行
- モバイルアプリ開発
- 他電子カルテ連携
- 音声入力対応

## 📝 ドキュメント管理

このPRDは、プロジェクトの全仕様へのインデックスとして機能します。各詳細仕様は個別のドキュメントに分割され、保守性と可読性を確保しています。

### ドキュメント更新ルール
1. 機能追加時は該当する仕様書を更新
2. 大きな変更はPRD.mdのインデックスも更新
3. 実装完了したら`status/implementation.md`を更新

## 🤝 コントリビューション

プロジェクトへの貢献を歓迎します。新機能提案、バグ報告、ドキュメント改善など、Issueまたはプルリクエストでお知らせください。

---

*最終更新: 2025年9月20日*
*バージョン: 4.0.0*